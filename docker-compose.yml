version: '2'
services:
    mysql:
        build: ./.data/resources/docker/mysql
        environment:
            MYSQL_ROOT_PASSWORD: root
            MYSQL_USER: go1
            MYSQL_PASSWORD: go1
        volumes:
            - './.data/mysql:/var/lib/mysql'
        ports:
            - '3306:3306'
    neo4j:
        image: neo4j
        environment:
            - NEO4J_AUTH=none
        volumes:
          - './.data/neo4j:/data'
        ports:
            - '7474:7474'
            - '7687:7687'
    queue:
        image: 'rabbitmq:3.6-management'
        environment:
            - RABBITMQ_DEFAULT_USER=go1
            - RABBITMQ_DEFAULT_PASS=go1
        ports:
          - '15672:15672'
    memcached:
        image: 'memcached:1.4-alpine'
    es:
        image: "go1com/ci-elasticsearch"
        volumes:
            - './.data/elasticsearch:/usr/share/elasticsearch/data'
        ports:
            - '9200:9200'
    consumer:
        build: ./.data/resources/docker/consumer
        command:
            - /app/app
        links:
            - queue
            - web
        environment:
            - QUEUE_URL=amqp://go1:go1@queue:5672/
            - SERVICE_URL_PATTERN=http://web/GO1/SERVICE/consume
            - CONSUMER_algolia=lo.create,lo.update,lo.delete,vote.#
            - CONSUMER_api=do.public-api.webhook-request,lo.#,enrolment.#,user.#,ro.create,ro.delete
            - CONSUMER_assessor=lo.delete,enrolment.delete,enrolment.create
            - CONSUMER_award=enrolment.#,plan.create
            - CONSUMER_cloudinary=lo.delete,user.delete,portal.delete
            - CONSUMER_enrolment=enrolment.update,enrolment.delete
            - CONSUMER_graphin=portal.#,user.#,lo.#,enrolment.#,tag.#,vote.#,group.#,ro.#,note.#,custom-tag.#
            - CONSUMER_index=portal.#,portal-config.#,user.#,lo.#,enrolment.#,ro.#,asm.assignment.#,asm.submission.#,group.#,eck.#,manual-record.#,transaction.#,quiz.user_answer.#,lo_group.#,coupon.#
            - CONSUMER_lazy=do.#
            - CONSUMER_low=group.#
            - CONSUMER_notify=enrolment.#,user.#,note.#,ro.#,award.#,plan.#,asm.#
            - CONSUMER_oembed=lo.update
            - CONSUMER_rules=portal.#,user.#,lo.#,enrolment.#,system.#
            - CONSUMER_stash=stash.#
            - CONSUMER_scraping=scraping.#
            # - CONSUMER_eck=enrolment.delete,lo.delete,portal.delete,user.delete
            # - CONSUMER_natero=portal.create,portal.update,contract.create,contract.update
        depends_on:
            - queue
        command: ["/scripts/wait-for-it.sh", "queue:5672", "-t", "0", "--", "/app/app"]
        volumes:
            - './infrastructure/wait-for-it:/scripts'
    worker:
        build: ./.data/resources/docker/worker
        command:
            - /app/app
        links:
            - queue
            - web
        environment:
            - QUEUE_URL=amqp://go1:go1@queue:5672/
            - SERVICE_URL_PATTERN=http://web/GO1/SERVICE/consume
        depends_on:
            - queue
        command: ["/scripts/wait-for-it.sh", "queue:5672", "-t", "0", "--", "/app/app"]
        volumes:
            - './infrastructure/wait-for-it:/scripts'
    ui:
        image: 'registry.code.go1.com.au/apiom/apiom-ui:master'
        command: ["ping", "127.0.0.1", "-q"]
    web:
        build: ./.data/resources/docker/web
        links:
            - memcached
            - neo4j
            - mysql
            - queue
            - es
        extra_hosts:
            - xdebug:${MONOLITH_XDEBUG_IP}
        ports:
            - '80:80'
        volumes:
            - './php/:/app/'
            - './php/vendor:/vendor/'
            - './.data/drupal/:/drupal/'
            - './.data/nginx/sites-available/:/etc/nginx/sites-available/'
            - './.data/nginx/autoload/:/autoload/'
            - './.data/cli/:/cli/'
            - './scripts/:/scripts/'
            - './.data/resources/docker/:/app/resources/docker/'
            - './infrastructure/wait-for-it:/scripts'
        volumes_from:
              - ui
        environment:
            - _DOCKER_RDS_DB_NAME=go1_dev
            - _DOCKER_RDS_HOSTNAME=mysql
            - _DOCKER_RDS_PASSWORD=root
            - _DOCKER_RDS_USERNAME=root
            - _DOCKER_GO1_DB_NAME=go1_dev
            - _DOCKER_GO1_HOSTNAME=mysql
            - _DOCKER_GO1_PASSWORD=root
            - _DOCKER_GO1_USERNAME=root
            - _DOCKER_CACHE_BACKEND=memcached
            - _DOCKER_CACHE_HOST=memcached
            - _DOCKER_CACHE_PORT=11211
            - MEMCACHED_HOST=memcached
            - MEMCACHED_PORT=11211
            - _DOCKER_QUEUE_HOST=queue
            - MONOLITH=1
            - ENV=dev
            - SERVICE_URL_PATTERN=http://web/GO1/SERVICE
            - ES_URL=http://es:9200
            # Quiz's environments
            - APP_ENV=monolith
            # Scorm's environments
            - SCORMENGINE_ENDPOINT=http://xdebug:9999/ScormEngineInterface/api/v1
            - SCORMENGINE_LAUNCH=http://localhost:9999
        depends_on:
            - queue
        command: ["/scripts/wait-for-it.sh", "queue:5672", "-t", "0", "--", "/usr/bin/supervisord", "-n", "-c", "/etc/supervisord.conf"]
